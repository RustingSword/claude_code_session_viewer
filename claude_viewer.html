<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Claude ä¼šè¯æŸ¥çœ‹å™¨</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
      mark {
        background-color: #fef08a;
        padding: 0 2px;
        border-radius: 2px;
      }
      .markdown-content h1 { font-size: 1.5em; font-weight: bold; margin: 0.5em 0; }
      .markdown-content h2 { font-size: 1.3em; font-weight: bold; margin: 0.5em 0; }
      .markdown-content h3 { font-size: 1.1em; font-weight: bold; margin: 0.5em 0; }
      .markdown-content code { background: #f1f5f9; padding: 0.2em 0.4em; border-radius: 3px; font-family: monospace; }
      .markdown-content pre { background: #f1f5f9; padding: 1em; border-radius: 6px; overflow-x: auto; }
      .markdown-content pre code { background: none; padding: 0; }
      .markdown-content ul { list-style: disc; margin-left: 1.5em; }
      .markdown-content ol { list-style: decimal; margin-left: 1.5em; }
      .markdown-content a { color: #3b82f6; text-decoration: underline; }

      /* æ”¹è¿› pre æ ‡ç­¾çš„æ–‡æœ¬æ¢è¡Œ */
      pre {
        white-space: pre-wrap;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }

      /* ç¡®ä¿ä»£ç å—ä¸ä¼šè¶…å‡ºå®¹å™¨ */
      pre code {
        display: block;
        max-width: 100%;
      }
    </style>
  </head>
  <body class="bg-slate-50 text-slate-900">
    <div class="flex h-screen">
      <!-- å·¦ä¾§è¾¹æ  -->
      <aside class="w-80 border-r bg-white flex flex-col">
        <div class="p-5 border-b">
          <div class="text-lg font-semibold">Claude ä¼šè¯æŸ¥çœ‹å™¨</div>
          <div class="text-xs text-slate-500 mt-1">
            æœ¬åœ°ä¼šè¯å†å²æµè§ˆå™¨
          </div>
          <label class="block text-xs text-slate-500 mt-4">é¡¹ç›®</label>
          <select
            id="projectSelect"
            class="mt-2 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
          ></select>
        </div>
        <div class="px-5 pt-4 text-xs uppercase text-slate-400 tracking-wider">
          ä¼šè¯åˆ—è¡¨
        </div>
        <div id="sessionList" class="flex-1 overflow-y-auto px-3 pb-4"></div>
      </aside>

      <!-- ä¸»å†…å®¹åŒº -->
      <main class="flex-1 flex flex-col">
        <!-- æœç´¢æ  -->
        <div class="border-b bg-white p-5">
          <div class="flex items-center gap-3">
            <input
              id="searchInput"
              type="text"
              placeholder="æœç´¢æ¶ˆæ¯å†…å®¹..."
              class="flex-1 rounded-lg border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
            />
            <label class="flex items-center gap-2 text-sm text-slate-600">
              <input type="checkbox" id="searchCurrentProjectOnly" class="rounded" />
              <span>ä»…å½“å‰é¡¹ç›®</span>
            </label>
            <button
              id="searchBtn"
              class="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-medium text-white hover:bg-indigo-700"
            >
              æœç´¢
            </button>
            <button
              id="clearSearchBtn"
              class="rounded-lg border border-slate-200 px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-50"
            >
              æ¸…é™¤
            </button>
          </div>
          <div id="searchMeta" class="mt-2 text-xs text-slate-500"></div>
        </div>

        <!-- æ¶ˆæ¯åˆ—è¡¨ -->
        <div class="flex-1 overflow-y-auto p-6">
          <div id="sessionMeta" class="mb-4 text-sm text-slate-500"></div>
          <div id="messageList" class="space-y-4"></div>

          <!-- æœç´¢ç»“æœ -->
          <div id="searchResults" class="hidden space-y-3"></div>

          <!-- åŠ è½½æ›´å¤šæŒ‰é’® -->
          <button
            id="loadMoreBtn"
            class="mt-6 hidden rounded-lg border border-slate-200 px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50"
          >
            åŠ è½½æ›´å¤š
          </button>
        </div>
      </main>
    </div>

    <script>
      // DOM å…ƒç´ å¼•ç”¨
      const projectSelect = document.getElementById("projectSelect");
      const sessionList = document.getElementById("sessionList");
      const messageList = document.getElementById("messageList");
      const sessionMeta = document.getElementById("sessionMeta");
      const searchInput = document.getElementById("searchInput");
      const searchBtn = document.getElementById("searchBtn");
      const clearSearchBtn = document.getElementById("clearSearchBtn");
      const searchMeta = document.getElementById("searchMeta");
      const searchResults = document.getElementById("searchResults");
      const loadMoreBtn = document.getElementById("loadMoreBtn");
      const searchCurrentProjectOnly = document.getElementById("searchCurrentProjectOnly");

      // åº”ç”¨çŠ¶æ€
      const state = {
        projects: [],
        currentProject: "",
        sessions: [],
        currentSessionId: "",
        offset: 0,
        limit: 200,
        hasMore: false,
        searchQuery: "",
        searchOffset: 0,
        searchHasMore: false,
        searchTotal: 0,
      };

      // å·¥å…·å‡½æ•°
      function formatTimestamp(timestamp) {
        if (!timestamp) return "";
        try {
          const date = new Date(timestamp);
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, "0");
          const day = String(date.getDate()).padStart(2, "0");
          const hours = String(date.getHours()).padStart(2, "0");
          const minutes = String(date.getMinutes()).padStart(2, "0");
          const seconds = String(date.getSeconds()).padStart(2, "0");
          return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        } catch {
          return timestamp;
        }
      }

      function escapeHtml(text) {
        return String(text || "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      function escapeRegex(text) {
        return text.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
      }

      function highlight(text, query) {
        const safe = escapeHtml(text || "");
        if (!query) return safe;
        const terms = query.trim().split(/\s+/).filter(Boolean);
        if (!terms.length) return safe;
        let out = safe;
        for (const term of terms) {
          const regex = new RegExp(escapeRegex(term), "ig");
          out = out.replace(regex, (match) => `<mark>${match}</mark>`);
        }
        return out;
      }

      async function api(path) {
        const res = await fetch(path);
        if (!res.ok) {
          throw new Error(`è¯·æ±‚å¤±è´¥: ${res.status}`);
        }
        return res.json();
      }

      // æ¸²æŸ“å‡½æ•°
      function renderProjects() {
        projectSelect.innerHTML = "";
        if (!state.projects.length) {
          const option = document.createElement("option");
          option.value = "";
          option.textContent = "æœªæ‰¾åˆ°é¡¹ç›®";
          projectSelect.appendChild(option);
          return;
        }
        for (const project of state.projects) {
          const option = document.createElement("option");
          option.value = project.project;
          option.textContent = `${project.project} (${project.session_count})`;
          projectSelect.appendChild(option);
        }
        projectSelect.value = state.currentProject;
      }

      function renderSessions() {
        sessionList.innerHTML = "";
        if (!state.sessions.length) {
          sessionList.innerHTML =
            '<div class="p-4 text-sm text-slate-400">æœªæ‰¾åˆ°ä¼šè¯</div>';
          return;
        }
        for (const session of state.sessions) {
          const isActive = session.session_id === state.currentSessionId;
          const wrapper = document.createElement("div");
          wrapper.className =
            "cursor-pointer rounded-lg border border-slate-200 bg-white p-3 mb-3 shadow-sm hover:border-indigo-300 transition-colors";
          if (isActive) {
            wrapper.classList.add("border-indigo-500", "shadow");
          }
          wrapper.dataset.sessionId = session.session_id;
          wrapper.innerHTML = `
            <div class="text-sm font-semibold text-slate-700">${escapeHtml(
              session.session_id.slice(0, 8)
            )}</div>
            <div class="text-xs text-slate-500 mt-1" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
              ${escapeHtml(session.summary || "æ— æ‘˜è¦")}
            </div>
            <div class="mt-2 text-[11px] text-slate-400 flex justify-between">
              <span>${escapeHtml(session.updated_at || "")}</span>
              <span>${session.message_count || 0} æ¡æ¶ˆæ¯</span>
            </div>
          `;
          wrapper.addEventListener("click", () => {
            loadSession(session.session_id);
          });
          sessionList.appendChild(wrapper);
        }
      }

      function renderSessionMeta() {
        const session = state.sessions.find(
          (s) => s.session_id === state.currentSessionId
        );
        if (!session) {
          sessionMeta.textContent = "";
          return;
        }
        sessionMeta.innerHTML = `
          <div class="flex flex-wrap gap-3 text-xs text-slate-500">
            <span class="font-semibold text-slate-700">${escapeHtml(
              session.session_id
            )}</span>
            <span>ä¼šè¯æ—¶é—´: ${formatTimestamp(session.started_at)} ~ ${formatTimestamp(session.updated_at)}</span>
            <span>æ¶ˆæ¯æ•°: ${session.message_count || 0}</span>
            <span>${escapeHtml(session.cwd || "")}</span>
            <span>${escapeHtml(session.git_branch || "")}</span>
          </div>
        `;
      }

      function parseContent(content) {
        if (!content) return [];
        try {
          const parsed = JSON.parse(content);
          return Array.isArray(parsed) ? parsed : [{ type: "text", text: String(content) }];
        } catch {
          return [{ type: "text", text: String(content) }];
        }
      }

      function formatJsonForDisplay(obj) {
        return JSON.stringify(obj, null, 2);
      }

      function unescapeJsonString(str) {
        return str.replace(/\\n/g, '\n').replace(/\\t/g, '\t');
      }

      function renderBox({ collapsible = false, bgClass, borderClass, titleClass = "", title = "", summary = "", bodyHtml }) {
        const containerClass = `mt-2 rounded-lg ${bgClass} border ${borderClass} p-3`;
        if (collapsible) {
          return `
            <details class="${containerClass}">
              <summary class="cursor-pointer text-xs font-semibold ${titleClass} select-none">
                ${summary}
              </summary>
              ${bodyHtml}
            </details>
          `;
        }
        const titleHtml = title
          ? `<div class="text-xs font-semibold ${titleClass}">${title}</div>`
          : "";
        return `
          <div class="${containerClass}">
            ${titleHtml}
            ${bodyHtml}
          </div>
        `;
      }

      function renderCollapsible({ bgClass, borderClass, summaryClass, summary, bodyHtml }) {
        return renderBox({
          collapsible: true,
          bgClass,
          borderClass,
          titleClass: summaryClass,
          summary,
          bodyHtml,
        });
      }

      function renderPanel({ bgClass, borderClass, titleClass, title, bodyHtml }) {
        return renderBox({ bgClass, borderClass, titleClass, title, bodyHtml });
      }

      function renderCodeBlock(content, extraClass = "") {
        const classes = `mt-2 text-xs text-slate-600 overflow-x-auto whitespace-pre-wrap break-words ${extraClass}`.trim();
        return `<pre class="${classes}"><code>${escapeHtml(content)}</code></pre>`;
      }

      function getRoleClasses(role, type) {
        if (role === "user" || type === "user") {
          return {
            badgeClass: "bg-indigo-600 text-white",
            bubbleClass: "bg-indigo-50 border-indigo-200",
          };
        }
        if (role === "assistant" || type === "assistant") {
          return {
            badgeClass: "bg-emerald-600 text-white",
            bubbleClass: "bg-emerald-50 border-emerald-200",
          };
        }
        return {
          badgeClass: "bg-slate-200 text-slate-600",
          bubbleClass: "bg-white border-slate-200",
        };
      }

      function renderTextBlock(text) {
        const content = text || "";
        const isSystemMessage = content.includes("<local-command-") || content.includes("<command-") || content.includes("<system-");

        if (isSystemMessage) {
          return renderCollapsible({
            bgClass: "bg-slate-100",
            borderClass: "border-slate-300",
            summaryClass: "text-slate-600",
            summary: `ğŸ“‹ ç³»ç»Ÿæ¶ˆæ¯ (${content.length} å­—ç¬¦)`,
            bodyHtml: `<div class="mt-2 text-xs text-slate-600 whitespace-pre-wrap break-words">${escapeHtml(content)}</div>`,
          });
        }

        if (content.length > 1500) {
          return renderCollapsible({
            bgClass: "bg-slate-50",
            borderClass: "border-slate-200",
            summaryClass: "text-slate-600",
            summary: `ğŸ“„ é•¿æ–‡æœ¬ (${content.length} å­—ç¬¦ï¼Œç‚¹å‡»å±•å¼€)`,
            bodyHtml: `<div class="mt-2 text-sm text-slate-800 markdown-content">${marked.parse(content)}</div>`,
          });
        }

        return `<div class="text-sm text-slate-800 markdown-content">${marked.parse(content)}</div>`;
      }

      function formatToolResultContent(block) {
        const content = block.content || block;
        if (typeof content === "string") {
          try {
            return formatJsonForDisplay(JSON.parse(content));
          } catch {
            return unescapeJsonString(content);
          }
        }
        return formatJsonForDisplay(content);
      }

      function renderToolResult(block) {
        const displayContent = formatToolResultContent(block);
        const isLong = displayContent.length > 2000;
        const bodyHtml = renderCodeBlock(displayContent, isLong ? "max-h-96" : "max-h-60");

        if (isLong) {
          return renderCollapsible({
            bgClass: "bg-green-50",
            borderClass: "border-green-200",
            summaryClass: "text-green-700",
            summary: `âœ“ å·¥å…·ç»“æœ (${displayContent.length} å­—ç¬¦ï¼Œç‚¹å‡»å±•å¼€)`,
            bodyHtml,
          });
        }

        return renderPanel({
          bgClass: "bg-green-50",
          borderClass: "border-green-200",
          titleClass: "text-green-700",
          title: "âœ“ å·¥å…·ç»“æœ",
          bodyHtml,
        });
      }

      const contentRenderers = {
        thinking: (block) => renderCollapsible({
          bgClass: "bg-amber-50",
          borderClass: "border-amber-200",
          summaryClass: "text-amber-700",
          summary: "ğŸ’­ æ€è€ƒè¿‡ç¨‹",
          bodyHtml: `<div class="mt-2 text-sm text-slate-700 markdown-content">${marked.parse(block.thinking || "")}</div>`,
        }),
        image: (block) => {
          const source = block.source || {};
          const data = source.data || "";
          if (!data) {
            return `<div class="text-sm text-slate-500">å›¾ç‰‡æ•°æ®ç¼ºå¤±</div>`;
          }
          const mediaType = source.media_type || "image/png";
          return renderPanel({
            bgClass: "bg-white",
            borderClass: "border-slate-200",
            titleClass: "text-slate-600 mb-2",
            title: "ğŸ–¼ï¸ å›¾ç‰‡",
            bodyHtml: `<img src="data:${mediaType};base64,${data}" class="max-w-full h-auto rounded" alt="æ¶ˆæ¯å›¾ç‰‡" />`,
          });
        },
        text: (block) => renderTextBlock(block.text),
        tool_use: (block) => renderPanel({
          bgClass: "bg-blue-50",
          borderClass: "border-blue-200",
          titleClass: "text-blue-700",
          title: `ğŸ”§ ${escapeHtml(block.name || "å·¥å…·è°ƒç”¨")}`,
          bodyHtml: renderCodeBlock(formatJsonForDisplay(block.input || {})),
        }),
        tool_result: renderToolResult,
      };

      function renderContentBlock(block) {
        if (!block || typeof block !== "object") {
          return `<div class="text-sm text-slate-800">${escapeHtml(String(block))}</div>`;
        }

        const type = block.type || "unknown";
        const renderer = Object.hasOwn(contentRenderers, type) ? contentRenderers[type] : null;
        if (renderer) {
          return renderer(block);
        }

        return `<pre class="text-xs text-slate-500 overflow-x-auto whitespace-pre-wrap break-words"><code>${escapeHtml(formatJsonForDisplay(block))}</code></pre>`;
      }

      function renderMessages(items) {
        if (!items.length) {
          messageList.innerHTML =
            '<div class="text-sm text-slate-400">æš‚æ— æ¶ˆæ¯</div>';
          return;
        }
        for (const item of items) {
          const role = item.role || item.type || "event";

          // è·³è¿‡ä¸æ˜¾ç¤ºçš„äº‹ä»¶ç±»å‹
          const skipTypes = ["summary", "file-history-snapshot", "progress"];
          if (item.type === "progress" || (skipTypes.includes(item.type) && !item.content)) {
            continue;
          }

          const { badgeClass, bubbleClass } = getRoleClasses(role, item.type);

          const wrapper = document.createElement("div");
          wrapper.className = `rounded-xl border ${bubbleClass} p-4 shadow-sm`;
          // æ·»åŠ IDä»¥æ”¯æŒé”šç‚¹è·³è½¬
          if (item.timestamp) {
            wrapper.id = `msg-${item.timestamp}`;
          }

          const contentBlocks = parseContent(item.content);
          const contentHtml = contentBlocks.map(block => renderContentBlock(block)).join("");

          wrapper.innerHTML = `
            <div class="flex items-center justify-between">
              <span class="rounded-full px-2 py-1 text-xs font-semibold ${badgeClass}">
                ${escapeHtml(role)}
              </span>
              <span class="text-xs text-slate-400">
                ${formatTimestamp(item.timestamp)}
              </span>
            </div>
            <div class="mt-3 space-y-2">
              ${contentHtml}
            </div>
          `;
          messageList.appendChild(wrapper);
        }
      }

      function renderSearchResults(results, append = false) {
        if (!append) {
          searchResults.innerHTML = "";
        }
        if (!results.length && !append) {
          searchResults.innerHTML =
            '<div class="text-sm text-slate-400">æœªæ‰¾åˆ°ç»“æœ</div>';
          return;
        }
        for (const result of results) {
          const card = document.createElement("div");
          card.className =
            "rounded-xl border border-slate-200 bg-white p-4 shadow-sm hover:shadow-md transition-shadow";
          card.innerHTML = `
            <div class="flex items-center justify-between text-xs text-slate-500">
              <span class="font-semibold text-slate-700">${escapeHtml(
                result.project
              )}</span>
              <span>${formatTimestamp(result.timestamp)}</span>
            </div>
            <div class="mt-2 text-xs text-slate-400">
              ä¼šè¯ ${escapeHtml(result.session_id)}
            </div>
            <div class="mt-3 text-sm text-slate-800 whitespace-pre-wrap break-words">
              ${highlight(result.excerpt || "", state.searchQuery)}
            </div>
            <div class="mt-3 flex gap-3">
              <button
                class="jump-to-message text-xs font-medium text-indigo-600 hover:text-indigo-800"
                data-session="${escapeHtml(result.session_id)}"
                data-project="${escapeHtml(result.project)}"
                data-timestamp="${escapeHtml(result.timestamp)}"
              >
                è·³è½¬åˆ°æ¶ˆæ¯ â†’
              </button>
              <button
                class="open-session text-xs font-medium text-slate-600 hover:text-slate-800"
                data-session="${escapeHtml(result.session_id)}"
                data-project="${escapeHtml(result.project)}"
              >
                æ‰“å¼€ä¼šè¯ â†’
              </button>
            </div>
          `;

          card.querySelector(".jump-to-message").addEventListener("click", () => {
            openSessionFromSearch({
              sessionId: result.session_id,
              project: result.project,
              timestamp: result.timestamp,
            }).catch(console.error);
          });

          card.querySelector(".open-session").addEventListener("click", () => {
            openSessionFromSearch({
              sessionId: result.session_id,
              project: result.project,
            }).catch(console.error);
          });

          searchResults.appendChild(card);
        }
      }

      function isSearchView() {
        return !searchResults.classList.contains("hidden");
      }

      async function ensureProjectLoaded(project) {
        if (project === state.currentProject) {
          return;
        }
        state.currentProject = project;
        projectSelect.value = project;
        await loadSessions(project);
      }

      function scrollToMessage(timestamp) {
        if (!timestamp) {
          return;
        }
        setTimeout(() => {
          const msgElement = document.getElementById(`msg-${timestamp}`);
          if (msgElement) {
            msgElement.scrollIntoView({ behavior: "smooth", block: "center" });
            msgElement.style.backgroundColor = "#fef3c7";
            setTimeout(() => {
              msgElement.style.backgroundColor = "";
            }, 2000);
          }
        }, 100);
      }

      async function openSessionFromSearch({ sessionId, project, timestamp }) {
        await ensureProjectLoaded(project);
        await loadSession(sessionId);
        showSessionView();
        if (timestamp) {
          scrollToMessage(timestamp);
        }
      }

      function setViewMode(showSearch) {
        searchResults.classList.toggle("hidden", !showSearch);
        messageList.classList.toggle("hidden", showSearch);
        if (showSearch) {
          loadMoreBtn.classList.add("hidden");
        }
      }

      function showSearchView() {
        setViewMode(true);
      }

      function showSessionView() {
        setViewMode(false);
      }

      // æ•°æ®åŠ è½½å‡½æ•°
      async function loadProjects() {
        const data = await api("/api/projects");
        state.projects = data.projects || [];
        state.currentProject = state.projects[0]?.project || "";
        renderProjects();
        if (state.currentProject) {
          await loadSessions(state.currentProject);
        }
      }

      async function loadSessions(project) {
        const data = await api(
          `/api/projects/${encodeURIComponent(project)}/sessions`
        );
        state.sessions = data.sessions || [];
        state.currentSessionId = state.sessions[0]?.session_id || "";
        renderSessions();
        renderSessionMeta();
        if (state.currentSessionId) {
          await loadSession(state.currentSessionId);
        } else {
          messageList.innerHTML =
            '<div class="text-sm text-slate-400">é€‰æ‹©ä¸€ä¸ªä¼šè¯æŸ¥çœ‹</div>';
        }
      }

      async function loadSession(sessionId, append = false) {
        state.currentSessionId = sessionId;
        // å¦‚æœä¸æ˜¯è¿½åŠ æ¨¡å¼ï¼Œé‡ç½®åˆ†é¡µçŠ¶æ€
        if (!append) {
          state.offset = 0;
        }
        const path = `/api/sessions/${encodeURIComponent(
          sessionId
        )}?project=${encodeURIComponent(state.currentProject)}&offset=${
          state.offset
        }&limit=${state.limit}`;
        const data = await api(path);
        state.hasMore = Boolean(data.next_offset);
        state.offset = data.next_offset || 0;
        if (!append) {
          messageList.innerHTML = "";
        }
        renderSessionMeta();
        renderMessages(data.items || []);
        loadMoreBtn.classList.toggle("hidden", !state.hasMore);
        renderSessions();
        showSessionView();
      }

      async function runSearch(append = false) {
        const query = searchInput.value.trim();
        state.searchQuery = query;
        if (!query) {
          searchMeta.textContent = "";
          showSessionView();
          return;
        }

        // å¦‚æœä¸æ˜¯è¿½åŠ æ¨¡å¼ï¼Œé‡ç½®æœç´¢çŠ¶æ€
        if (!append) {
          state.searchOffset = 0;
          searchResults.innerHTML = "";
        }

        let path = `/api/search?q=${encodeURIComponent(query)}&offset=${state.searchOffset}&limit=50`;
        // åªæœ‰å‹¾é€‰äº†"ä»…å½“å‰é¡¹ç›®"ä¸” currentProject å­˜åœ¨æ—¶æ‰æ·»åŠ  project å‚æ•°
        if (searchCurrentProjectOnly.checked && state.currentProject) {
          path += `&project=${encodeURIComponent(state.currentProject)}`;
        }
        try {
          const data = await api(path);
          state.searchTotal = data.total || 0;
          state.searchHasMore = data.has_more || false;
          state.searchOffset = data.offset + (data.results?.length || 0);

          searchMeta.textContent = `æ‰¾åˆ° ${state.searchTotal} æ¡ç»“æœï¼Œå·²æ˜¾ç¤º ${state.searchOffset} æ¡`;

          renderSearchResults(data.results || [], append);
          showSearchView();

          // æ˜¾ç¤ºæˆ–éšè—"åŠ è½½æ›´å¤š"æŒ‰é’®
          loadMoreBtn.classList.toggle("hidden", !state.searchHasMore);
        } catch (error) {
          searchMeta.textContent = `æœç´¢é”™è¯¯: ${error.message}`;
          searchResults.innerHTML = `<div class="text-sm text-red-600">${escapeHtml(error.message)}</div>`;
          showSearchView();
        }
      }

      // äº‹ä»¶ç›‘å¬
      projectSelect.addEventListener("change", async (event) => {
        state.currentProject = event.target.value;
        state.offset = 0;
        await loadSessions(state.currentProject);
      });

      searchBtn.addEventListener("click", runSearch);
      clearSearchBtn.addEventListener("click", () => {
        searchInput.value = "";
        searchMeta.textContent = "";
        showSessionView();
      });
      searchInput.addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          runSearch();
        }
      });
      loadMoreBtn.addEventListener("click", async () => {
        if (isSearchView()) {
          await runSearch(true);
        } else {
          await loadSession(state.currentSessionId, true);
        }
      });

      // åˆå§‹åŒ–
      loadProjects().catch((error) => {
        messageList.innerHTML = `<div class="text-sm text-red-600">${escapeHtml(
          error.message
        )}</div>`;
      });
    </script>
  </body>
</html>
